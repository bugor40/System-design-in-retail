# ML Design (HSE retail course)

## 1. Цели и предпосылки
### 1.1 Зачем нужно идти в разработку продукта
**Бизнес-цель** - оптимизация текущих процессов распределения курьеров между зонами доставки для:
- сокращения времени доставки в высоконагруженных зонах, а также в часы пик.

**Побочная цель** - оптимизация людских ресурсов и затрат на них в малозагруженных зонах.

**Текущий бизнес процесс**
В каждом городе есть в среднем 30 дарксторов. К каждому даркстору привязаны зоны, которые не пересекаются между собой. Каждый даркстор осуществляет доставку по двум типов заказов:
- быстрые (в течение 60 мин. с момента завершения заказа)
- доставка к конкретному времени (заранее указывается желаемый часовой слот доставки)

> *предположим*, что...
На данный момент распределение курьеров на зоны происходит на базе экспертной оценки менеджеров (т.е за каждой зоной города закрепляется какое-то кол-во курьеров, которое сможет обеспечить доставку заказов в каждой из зон).

**Польза от внедрения ML**
Внедрение ML модели сократит время доставки заказов и оптимизирует затраты на содержание персонала (курьеров), а  также избавит от ручных расчётов необходимого количества курьеров.

**Бизнес-критерии успеха:**
- сокращение среднего времени доставки ${t}$ после внедрения модели
- сокращение необходимого количества курьеров

**Критерии успеха в терминах ML:**
Скорость доставки напрямую зависит от двух факторов:
1) Как быстро курьер сможет освободиться и забрать заказ
2) На сколько большая зона закреплённая за даркстором 

> для упрощения примем, что все зоны +- одинаковы по площади, и среднее время доставки от момента получения заказа курьером в каждой из зон тоже одинаковое

Учитывая допущения выше, можно сказать, что скорость доставки заказа от момента заказа до получения этого заказа клиентом зависит только от количества курьеров и количества заказов в данной зоне.

Таким образом ML модель должна давать прогноз заказов в конкретной зоне с точностью ≥ экспертной оценки менеджеров, но не менее 85%
$$1-WAPPE_{модель}≥1-WAPPE_{менеджер}$$

WAPPE - метрика взвешенной процентной ошибки. Ключевым отличием от WAPE является то, что процент ошибки считается не от фактического значения, а от предсказанного. Такой приём позволяет чаще преувеличить прогноз, чем занизить его при прямой оптимизации этой метрики при обучении.

$$WAPPE={\frac{{\displaystyle\sum_{i=1}^{N}|y_{true}}-y_{pred}|}{\displaystyle\sum_{i=1}^{N}|y_{pred}|}},$$

$N$ – общее количество периодов (например 4 часа) для предсказания

$\hat{y}_{true}$ – истинное значение заказов в период

$y_{pred}$ – предсказанное значение в период

Также ресурсы затраченные на разработку ML-модели должны быть окупаемы эффектом которое получится от её внедрения:
 

##### Затраты сейчас:
$$COST_{before}=N*{t}+{w}*S$$

${N}$ – общее количество дарксторов в городе;

${t}$ – среднее время, затрачиваемое менеджера на аналитику необходимого количества курьеров;

${w}$ – стоимость работы курьера в час;

${S}$ – количество курьеров;

##### Затраты на внедрение проекта:
$$COST_{pr}=t_{sum}*{w} + {h}$$

$t_{sum}$ – суммарное затраченное время на проект

$w$ – совокупная почасовая ставка команды

$h$ - проведение пилота

##### Затраты после внедрения проекта
$$COST_{after}={w}*S$$

${w}$ – стоимость работы курьера в час;

${S}$ – количество курьеров;

Считаем, что проект успешный, если $COST_{after}$ < $COST_{before}$ и $COST_{pr}$ окупается за 2 года

### **1.2 Бизнес требования и ограничения**
**Целевое видение**

- Необходимо делать предсказание количества заказов для каждого даркстора на горизонт одного дня. Прогнозы делаются ночью каждый день.
- Гранулярность расчёта – даркстор, количество заказов в 4 часа.
- Предсказываются заказы отдельно для каждого дакстора в городе, всего в городе около 30 дарксторов. 
- Истинные исторические значения заказов имеются во внутренней системе, данные загружаются ночью следующих суток. 
- Создание дашборда для визуализации предсказаний модели и фактом заказов. 
- Интеграция результатов во внутренние системы компании. Результаты расчёта заносятся во внутреннюю систему и доступны всем.
- Переобучение модели происходит ночью с сб на вск каждой недели.

**Бизнес-требования и ограничения для пилота**

- Необходимо делать предсказание количества заказов для каждого даркстора на горизонт одного дня в течение 1го месяца.
- Гранулярность расчёта – даркстор, количество заказов в период 4 часов.
- Пилот проводиться на одном городе. 

**Проведение пилота**

- Оценка пилота будет проводится в рамках одного города в течение одного месяца.

    Плюсы:
    - Можно оценить эффект без высоких рисков для бизнеса
    - Скорость проведения пилота

    Недостатки:
    - Выбранный для пилота город может оказаться нерепрезентативным


- Процесс тестирования модели

    Обучение и валидация модели производится на имеющихся исторических данных заказов. 

    На тестовых данных вычисляется и скравниваются WAPPE модели и менеджеров. Производится оценка эффекта от внедрения модели.

**Критерии успешности пилота**

- $1-WAPPE_{модель}≥1-WAPPE_{менеджер}$
- $COST_{after} < COST_{before}$ и $COST_{pr}$ окупается за 2 года
- сокращение среднего времени доставки ${t}$

### 1.3. Что (не) входит в скоуп проекта
- модель строится без учёта гео-специфики каждой зоны;
- учитывается только спрос в каждой конкретной зоне;
- не разрабатывается отдельный алгоритм для вызова на смену курьеров, только перебалансировка всех в зависимости от кол-ва заказов

### 1.4. Предпосылки решения 


## 2 Методология
### 2.1 Постановка задачи
Создание прогнозной модели, задача предсказания временного ряда.
### 2.2  Этапы решения задачи
**1) Подготовка данных**

Для обучения и валидации модели необходимы почасовые counter-ы заказов в разрезе каждого даркстора за последний год.
Выборку делим на train и test в соотношении 10:2 (в тест попадает 2 последних месяца от отобранного года)

**2) Проверка данных**
- проверка данных на пропуски (менее 5%) - пропуски заполняются значением которое было 24 часа назад
- проверка на отсутствие положительных выбросов (выбросы клипируем по 99 перцентилю)
- проверка на отсутствие отрицательных выбросов (обрабатываем также ка и пропуски)

**3) Построение моделей**

В качестве бэйзлайна выступает экспертная оценка менеджеров. Так как спрос имеет почасовую сезонность, то в качестве прогнозной модели рассматривается сезонная адитивная модель Хольта-Винтерса. В первой итерации стоит попробовать именно простую модель, так как возможно удасться достигнуть необходимых значений метрик малыми усилиями.

Модель времнного ряда
$$y_t = l_t + s_{t}+\varepsilon_t$$
где $s_t$ - переменная отвечающая за сезонность периода $p$

Модель прогнозирования

$$\hat{y}__{t+d} = \hat l_t + \hat s_{t+(d\ mod p) - p};\\
\hat l_{t} = \alpha \left(y_t - \hat s_{t-p}\right)+ \left(1-\alpha\right) \left(\hat l_{t-1}\right)={\hat l_{t-1} + \alpha e_t};\\
\hat s_t = \gamma\left(y_t- \hat l_{t}\right) + \left(1-\gamma\right)\hat s_{t-p} = {\hat s_{t-p} + \gamma(1-\alpha)e_t}$$

Для каждого даркстора существует временной ряд и следовательно для каждого будет строится отдельная модель, прогнозирующая количество заказов. Далее на основе предсказания каждой модели считается доля заказов каждого даркстора города от общего количества спрогнозированных заказов в городе на конкртеный час.

$$Q_{i} = {\frac{D_{i}}{\displaystyle\sum_{i=1}^{D}D_{i}}} * Q,$$

где 

$D$ - количество заказов в дарксторах

$Q$ - количество курьеров в городе

$Q_{i}$ - количество курьеров в конкретном дарксторе


Построение модели и подбор гиперпараметров проводится на обучающей выборке путём разбиения выборки на 5 фолдов с сохранением временного порядка. Перебираем гиперпараметры $\alpha$ и $\gamma$ жадным поиском и валидируясь последовательно обучившись на 1-ом фолде прогнозируя 2-й, обучившись на 1-ом и 2-ом прогнозируя 3-й и тд. Сезонность подбираем исходя из экспертной оценки. Финальный набор гиперпараметров определям по итоговому качеству скоров модели для одного даркстора.

**4) Оценка модели**

Обученная модель применяется к тестовым данным. Оценивается метрика WAPPE в разрезе одного даркстора и финальная метрика WAPPE после применения моделей для каждой из модели.

Плюсы:
- модель быстро обучается и не требует сложных настроек
- модель хорошо интерпритируется

Риски:
- из-за простоты модели её предсказательной силы может не хватать

**5) Бизнес правила**

> С учётом всех допущений которые были сделаны выше, дполнительно стоит отметить, что

Заказы весом больше 7кг сделать невозможно, нужно разбивать на два.

**6) Инференс модели**
![Схема работы](https://github.com/bugor40/System-design-in-retail/blob/main/%D0%91%D0%B5%D0%B7%20%D0%BD%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F.png
)

Инференс модели настраиваем следующим образом
1) Собираем логи сервиса заказов в БД 
2) Из БД берём историю заказов
3) Делаем подготовку данных и делим на train и valid
4) Обучаем модель
5) Деламе прогноз и сохраняем метрики
6) Отправляем результаты менеджерам отвечающих за курьеров

Всё это работает под шедулером с периодом в неделю.

## **3 Пилот**
### **3.1 Описание методики пилота**
Для выбранного города раскатывается система оптимизации курьерских ресурсов. После первого месяца проверяются метрики, спустя месяц ещё раз. Расчитывается средняя скорость доставки и WAPPE ошибки факта и прогноза заказов.

На данном этапе развития проекта A/B тест не производится, т.к. отдача от проекта должна быть столь значительна, что статистически подтверждать гипотезы не должно иметь смысла. 
### **3.2 Оценка успешности пилота**
см. Общие критерии успешности проекта.

## **4 Внедрение в production**
Серьёзных доработок не требуется, нужно раскатить на все города в которых представлена сеть.
